# About qac (quack anticheat)

Source: [https://github.com/zerothefallen/Quack-Anti-Cheat](https://github.com/zerothefallen/Quack-Anti-Cheat)

This is a very old (~2014) anticheat written by someone who curses a lot in their source code comments.  
The "screengrab" code didn't work when executed, which is why it's being skipped in this explanation.


# How qac works

Qac, atleast on the clientside, works by overwriting specific functions and checking from where they are executed from.  
This means that, for example, whenever the function `RunString` is executed the anticheat checks from where it was executed from and asks the server about it. This means every execution of those functions sends a net message to the server for verification if the source is not explicitly whitelisted on the client.

It also (tries) to verify console variables like `sv_cheats` periodically and if the values have been tempered with it tells the server about it.


# Easily evade everything

The easiest way to circumvent the whole anticheat: Load your external lua code / cheats with a fake source of a file that already exists.  
Example: Your code loads from `C:\test.lua` but the ingame source shows it as `C:\Program Files (x86)\Steam\steamapps\common\GarrysMod\garrysmod\lua\includes\init.lua` (which displays `lua\includes\init.lua`). This would make the anticheat think that everything is OK and you could execute whatever you want.

The other variant that always works ofcourse: Load your custom lua code / cheats BEFORE the anticheat loads. This disables any and all anticheats if done correctly, and there is barely anything one can do against it.


# Disable functions with lua code

## ConVar periodic check

The ConVar check begins at [https://github.com/zerothefallen/Quack-Anti-Cheat/blob/5f4958d4150f6607772e6a043ad0e2446f6a0677/lua/autorun/client/!!_cl_qac.lua#L157](https://github.com/zerothefallen/Quack-Anti-Cheat/blob/5f4958d4150f6607772e6a043ad0e2446f6a0677/lua/autorun/client/!!_cl_qac.lua#L157)

The `qac.timecheck()` function won't run because:

 - The author wrote "validate_cvar" instead of "qac.validate_cvar", which means no convar can be checked because the function doesn't exist
 - The author wrote "qac.math.random(mintime,maxtime)" , which won't work because the variables are "qac.mintime,qac.maxtime". This means the check couldn't run multiple times because it would error after the first run
 - The author never called this function, which means it never starts the cycle in the first place

This means we don't actually have to write code to prevent this from working.  
I tested this and it didn't execute the timecheck function.  
But if it would work we could overwrite the check with the following code:

```lua
FindMetaTable("ConVar").oldGetString = FindMetaTable("ConVar").GetString
FindMetaTable("ConVar").GetString = function(self)
    if self:GetName() == "sv_cheats" then return "0" end
    return self:oldGetString()
end
```

The above code overwrites the ConVar's `:GetString` method and hardcodes the response `"0"` if the wanted ConVar name is "sv_cheats".  
This works because the author forgot to localize the ConVar:GetString method, which means we can overwrite it from the outside.


## General functionality

The anticheat overwrites functions and adds checks for the source of execution to it.  
This check uses only localized functions inside the anticheat's lua file, which means we can not simply overwrite the function again.

BUT: The author forgot to use the localized version of `table.HasValue`.  
This happens on the following line: [https://github.com/zerothefallen/Quack-Anti-Cheat/blob/5f4958d4150f6607772e6a043ad0e2446f6a0677/lua/autorun/client/!!_cl_qac.lua#L89](https://github.com/zerothefallen/Quack-Anti-Cheat/blob/5f4958d4150f6607772e6a043ad0e2446f6a0677/lua/autorun/client/!!_cl_qac.lua#L89)  
This line shows:  

```lua
if table.HasValue(qac.sources, src) then
```

But it should have been using `qac.table.HasValue` instead.

This line of code checks if the source is OK or not. This line is the heart of the anticheat and we can simply overwrite it with the following code:

```lua
local oldTableHasValue = table.HasValue
function table.HasValue(tab,val)
    if val == "MyCheatSourceHere.lua" then return true end
    return oldTableHasValue(tab,val)
end
```

The above code overwrites the `table.HasValue` and adds a hardcoded response of "Yes, it has this value" for the source of your own external lua file.  
This means we can now execute any and all lua code from this `MyCheatSourceHere.lua` lua file without having to worry about any anticheat checks catching anything.

