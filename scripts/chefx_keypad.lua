--Chef xtra // keypad code finder
--Made by OverlordAkise

--This will print the code of a keypad if a player entered it with his mouse
--It is not 100% accurate and can tell you invalid codes which are off by 1
--This is not easily fixable because of inaccuracy in calculations with aimvector of players

local function printcode(ply,keypad,code)
    chat.PlaySound()
    print(ply:Nick(),"has keypad code",code)
end

hook.Add("Think", "ThinkForEntities", function()
    if not IsValid(LocalPlayer()) then return end
    for k,ply in ipairs(player.GetHumans()) do
        local kp = ply:GetEyeTrace().Entity
        if not IsValid(kp) or not IsValid(ply) or not string.find(kp:GetClass(), "Keypad") or ply:EyePos():Distance(kp:GetPos()) > 120 then continue end
        
        local i = kp:GetHoveredElement()
        if not i then return end
        i = i.text
        kp.tempCode = kp.tempCode or ""
        kp.tempText = kp.tempText or ""
        kp.tempStatus = kp.tempStatus or 0
        if kp:GetText() == kp.tempText and kp:GetStatus() == kp.tempStatus then
            ply.lastKeyLookedAt = i
            continue
        end
        kp.tempText = kp:GetText()
        kp.tempStatus = kp:GetStatus()
        if not kp:GetSecure() then
            kp.tempCode = kp.tempText
            if kp.tempStatus == 1 and kp.tempCode ~= "" then
                kp.code = kp.tempCode
                printcode(ply,kp,kp.code)
            end
        else
            
            if kp.tempStatus == 1 and kp.tempCode ~= "" then
                kp.code = kp.tempCode
                kp.tempCode = ""
                printcode(ply,kp,kp.code)
            end
            if kp.tempText == "" or kp.tempStatus == 2 then
                kp.tempCode = ""
            end
            if tonumber(i) and kp:GetText():len() ~= 0 then
                if ply.lastKeyLookedAt then
                    kp.tempCode = kp.tempCode..ply.lastKeyLookedAt
                else
                    kp.tempCode = kp.tempCode..i
                end
            end
            if not i then continue end
            ply.lastKeyLookedAt = i
        end
    end
end)
